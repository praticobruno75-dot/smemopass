<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>SMEMOPASS - Gestore Password Sicuro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23667eea;stop-opacity:1' /><stop offset='100%' style='stop-color:%23764ba2;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23grad)'/><path d='M50 25 L50 35 M35 45 L65 45 M30 45 L30 75 Q30 80 35 80 L65 80 Q70 80 70 75 L70 45 M40 50 L40 70 M50 50 L50 70 M60 50 L60 70' stroke='white' stroke-width='4' fill='none' stroke-linecap='round'/><circle cx='50' cy='30' r='8' fill='white'/></svg>">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SMEMOPASS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Gestore password sicuro e offline con crittografia AES-256">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad2' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23667eea;stop-opacity:1' /><stop offset='100%' style='stop-color:%23764ba2;stop-opacity:1' /></linearGradient></defs><rect width='180' height='180' rx='40' fill='url(%23grad2)'/><path d='M90 45 L90 63 M63 81 L117 81 M54 81 L54 135 Q54 144 63 144 L117 144 Q126 144 126 135 L126 81 M72 90 L72 126 M90 90 L90 126 M108 90 L108 126' stroke='white' stroke-width='7' fill='none' stroke-linecap='round'/><circle cx='90' cy='54' r='14' fill='white'/></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* PWA Fullscreen mode adjustments */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .container {
                max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                overflow-y: auto;
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }

        .login-screen {
            padding: 60px 40px;
            text-align: center;
        }

        .login-screen h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .login-screen p {
            color: #666;
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-small {
            font-size: 16px;
            font-weight: 700;
            padding: 14px 20px;
            padding: 14px 20px;
            font-size: 16px;
            width: auto;
            display: inline-block;
            margin: 5px;
        }

        .main-app {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .content {
            padding: 30px;
                    overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .password-list {
            display: grid;
            gap: 15px;
        }

        .password-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .password-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .password-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .password-card-title {
            font-size: 1.3em;
            color: #333;
            font-weight: 600;
        }

        .password-card-category {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .password-card-info {
            margin: 10px 0;
            color: #666;
        }

        .password-card-info strong {
            color: #333;
            display: inline-block;
            min-width: 80px;
        }

        .password-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .icon-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
        }

        .btn-copy {
            background: #28a745;
            color: white;
        }

        .btn-show {
            background: #17a2b8;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .password-strength {
            margin-top: 5px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: all 0.3s;
        }

        .strength-weak { background: #dc3545; width: 33%; }
        .strength-medium { background: #ffc107; width: 66%; }
        .strength-strong { background: #28a745; width: 100%; }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .password-generator {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generator-options {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .generated-password {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 16px;
            word-break: break-all;
            margin: 10px 0;
            border: 2px solid #667eea;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .toolbar {
                flex-direction: column;
            }

            .password-card-actions {
                flex-wrap: wrap;
            }
        }

        .file-input-label {
            display: inline-block;
            padding: 14px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: transform 0.2s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        input[type="file"] {
            display: none;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .category-item.default {
            background: #e7f3ff;
            border-color: #667eea;
        }

        .category-item-name {
            font-weight: 500;
            color: #333;
        }

        .category-item-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .btn-delete-category {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-delete-category:hover {
            background: #c82333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-icon {
            font-size: 3em;
            opacity: 0.9;
        }

        .stats-content {
            flex: 1;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            line-height: 1;
        }

        .stats-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .dashboard-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .dashboard-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .issue-list {
            display: grid;
            gap: 15px;
        }

        .issue-item {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .issue-item.warning {
            background: #fffbf0;
            border-left-color: #ffc107;
        }

        .issue-item.info {
            background: #f0f8ff;
            border-left-color: #17a2b8;
        }

        .issue-content {
            flex: 1;
        }

        .issue-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .issue-description {
            color: #666;
            font-size: 0.9em;
        }

        .issue-action {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .issue-action:hover {
            background: #5568d3;
        }

        .category-chart {
            display: grid;
            gap: 15px;
        }

        .category-bar-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-bar-label {
            min-width: 150px;
            font-weight: 500;
            color: #333;
        }

        .category-bar-wrapper {
            flex: 1;
            background: #f0f0f0;
            border-radius: 8px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }

        .category-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .empty-dashboard {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-dashboard svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <h1>üîê SMEMOPASS</h1>
            <p>Inserisci la tua password master per accedere</p>
            
            <div class="input-group">
                <label for="masterPassword">Password Master</label>
                <input type="password" id="masterPassword" placeholder="Inserisci la password master" autocomplete="off">
            </div>
            
            <button class="btn" onclick="login()">Accedi</button>
            <button class="btn btn-secondary" onclick="showFirstTimeSetup()">Prima configurazione</button>
        </div>

        <!-- First Time Setup Screen -->
        <div class="login-screen" id="setupScreen" style="display: none;">
            <h1>üîê SMEMOPASS</h1>
            <p>Crea una password master per proteggere le tue password</p>
            
            <div class="input-group">
                <label for="setupPassword">Password Master (minimo 8 caratteri)</label>
                <input type="password" id="setupPassword" placeholder="Crea una password master" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label for="setupPasswordConfirm">Conferma Password Master</label>
                <input type="password" id="setupPasswordConfirm" placeholder="Conferma la password" autocomplete="off">
            </div>
            
            <button class="btn" onclick="completeSetup()">Crea</button>
            <button class="btn btn-secondary" onclick="backToLogin()">Annulla</button>
        </div>

        <!-- Main App -->
        <div class="main-app" id="mainApp">
            <div class="header">
                <h1>üîê SMEMOPASS</h1>
                <div class="header-actions">
                    <button class="btn btn-small" onclick="showInstructions()">üìñ Istruzioni</button>
                    <button class="btn btn-small" onclick="showSettings()">‚öôÔ∏è Impostazioni</button>
                    <button class="btn btn-small" onclick="showExportModal()">üíæ Backup</button>
                    <button class="btn btn-small" onclick="showImportModal()">üì• Import</button>
                    <button class="btn btn-small btn-danger" onclick="logout()">Esci</button>
                </div>
            </div>

            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                    <button class="tab-btn" onclick="switchTab('passwords')">üîê Password</button>
                    <button class="tab-btn" onclick="switchTab('memory')">üíæ Memoria Digitale</button>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboardSection" class="tab-content active">
                    <div class="dashboard-grid">
                        <!-- Statistics Cards -->
                        <div class="stats-card">
                            <div class="stats-icon">üîê</div>
                            <div class="stats-content">
                                <div class="stats-number" id="totalPasswords">0</div>
                                <div class="stats-label">Password Totali</div>
                            </div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-icon">üíæ</div>
                            <div class="stats-content">
                                <div class="stats-number" id="totalMemory">0</div>
                                <div class="stats-label">Informazioni</div>
                            </div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-icon">‚ö†Ô∏è</div>
                            <div class="stats-content">
                                <div class="stats-number" id="weakPasswords">0</div>
                                <div class="stats-label">Password Deboli</div>
                            </div>
                        </div>

                        <div class="stats-card">
                            <div class="stats-icon">üîÑ</div>
                            <div class="stats-content">
                                <div class="stats-number" id="duplicatePasswords">0</div>
                                <div class="stats-label">Password Duplicate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Issues -->
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">üõ°Ô∏è Problemi di Sicurezza</h2>
                        <div id="securityIssues" class="issue-list">
                            <!-- Issues will be populated here -->
                        </div>
                    </div>

                    <!-- Old Passwords -->
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">‚è∞ Password Vecchie (6+ mesi)</h2>
                        <div id="oldPasswords" class="issue-list">
                            <!-- Old passwords will be populated here -->
                        </div>
                    </div>

                    <!-- Category Distribution -->
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">üìä Distribuzione per Categoria</h2>
                        <div id="categoryChart" class="category-chart">
                            <!-- Category bars will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Password Section -->
                <div id="passwordSection" class="tab-content active">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="üîç Cerca password..." oninput="filterPasswords()">
                        </div>
                        <select class="filter-select" id="categoryFilter" onchange="filterPasswords()">
                            <option value="">Tutte le categorie</option>
                        </select>
                        <button class="btn btn-small" onclick="showCategoryManager('password')">üìÅ Categorie</button>
                        <button class="btn btn-small btn-success" onclick="showAddModal()">+ Aggiungi</button>
                    </div>

                    <div class="password-list" id="passwordList">
                        <!-- Password cards will be inserted here -->
                    </div>
                </div>

                <!-- Memory Section -->
                <div id="memorySection" class="tab-content">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" id="searchMemoryInput" placeholder="üîç Cerca informazioni..." oninput="filterMemory()">
                        </div>
                        <select class="filter-select" id="memoryCategoryFilter" onchange="filterMemory()">
                            <option value="">Tutte le categorie</option>
                        </select>
                        <button class="btn btn-small" onclick="showCategoryManager('memory')">üìÅ Categorie</button>
                        <button class="btn btn-small btn-success" onclick="showAddMemoryModal()">+ Aggiungi</button>
                    </div>

                    <div class="password-list" id="memoryList">
                        <!-- Memory cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="addEditModal">
        <div class="modal-content">
            <h2 class="modal-header" id="modalTitle">Aggiungi Password</h2>
            
            <div class="input-group">
                <label for="entryTitle">Titolo *</label>
                <input type="text" id="entryTitle" placeholder="es. Facebook, Gmail, ecc.">
            </div>

            <div class="input-group">
                <label for="entryCategory">Categoria *</label>
                <select id="entryCategory">
                </select>
            </div>

            <div class="input-group">
                <label for="entryUsername">Username / Email</label>
                <input type="text" id="entryUsername" placeholder="username o email">
            </div>

            <div class="input-group">
                <label for="entryEmail">Email aggiuntiva</label>
                <input type="email" id="entryEmail" placeholder="email@esempio.com">
            </div>

            <div class="password-generator">
                <strong>Generatore Password</strong>
                <div class="generator-options">
                    <div class="input-group">
                        <label>Lunghezza: <span id="lengthValue">16</span></label>
                        <input type="range" id="genLength" min="8" max="32" value="16" oninput="document.getElementById('lengthValue').textContent = this.value">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="genUppercase" checked>
                        <label for="genUppercase">Maiuscole (A-Z)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="genLowercase" checked>
                        <label for="genLowercase">Minuscole (a-z)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="genNumbers" checked>
                        <label for="genNumbers">Numeri (0-9)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="genSymbols" checked>
                        <label for="genSymbols">Simboli (!@#$%^&*)</label>
                    </div>
                </div>
                <button class="btn btn-small" onclick="generateAndFillPassword()">Genera Password</button>
                <div class="generated-password" id="generatedPasswordDisplay" style="display:none;"></div>
            </div>

            <div class="input-group">
                <label for="entryPassword">Password *</label>
                <input type="password" id="entryPassword" placeholder="password" oninput="checkPasswordStrength()">
                <div class="password-strength">
                    <div class="password-strength-bar" id="strengthBar"></div>
                </div>
            </div>

            <div class="input-group">
                <label for="entryUrl">URL / Sito Web</label>
                <input type="url" id="entryUrl" placeholder="https://esempio.com">
            </div>

            <div class="input-group">
                <label for="entryNotes">Note</label>
                <textarea id="entryNotes" placeholder="Note aggiuntive..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" onclick="saveEntry()">Salva</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2 class="modal-header">Esporta Password</h2>
            <p>Scarica un backup crittografato delle tue password. Il file √® protetto dalla tua password master.</p>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="exportData()">Scarica Backup</button>
                <button class="btn btn-secondary" onclick="closeExportModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2 class="modal-header">Importa Password</h2>
            <p>Carica un file di backup precedentemente esportato. <strong>Attenzione:</strong> questo sostituir√† tutti i dati attuali.</p>
            <div class="input-group">
                <label for="importFile" class="file-input-label">Scegli file di backup</label>
                <input type="file" id="importFile" accept=".json">
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="importData()">Importa</button>
                <button class="btn btn-secondary" onclick="closeImportModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h2 class="modal-header" id="categoryModalTitle">Gestione Categorie</h2>
            
            <div class="input-group">
                <label for="newCategoryName">Nuova Categoria</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategoryName" placeholder="Nome categoria" style="flex: 1;">
                    <button class="btn btn-small btn-success" onclick="addCategory()">Aggiungi</button>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <strong>Categorie Esistenti:</strong>
                <div id="categoryList" style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
                    <!-- Categories will be listed here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCategoryModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Memory Modal -->
    <div class="modal" id="addEditMemoryModal">
        <div class="modal-content">
            <h2 class="modal-header" id="memoryModalTitle">Aggiungi Informazione</h2>
            
            <div class="input-group">
                <label for="memoryTitle">Titolo *</label>
                <input type="text" id="memoryTitle" placeholder="es. IBAN principale, Codice Fiscale, ecc.">
            </div>

            <div class="input-group">
                <label for="memoryCategory">Categoria *</label>
                <select id="memoryCategory">
                </select>
            </div>

            <div class="input-group">
                <label for="memoryData">Informazione *</label>
                <input type="text" id="memoryData" placeholder="Inserisci il dato da salvare">
            </div>

            <div class="input-group">
                <label for="memoryAdditionalInfo">Informazioni aggiuntive</label>
                <input type="text" id="memoryAdditionalInfo" placeholder="es. Banca, ente emittente, ecc.">
            </div>

            <div class="input-group">
                <label for="memoryNotes">Note</label>
                <textarea id="memoryNotes" placeholder="Note aggiuntive..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-success" onclick="saveMemoryEntry()">Salva</button>
                <button class="btn btn-secondary" onclick="closeMemoryModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 class="modal-header">‚öôÔ∏è Impostazioni</h2>
            
            <div class="input-group">
                <label for="inactivityTimeout">Timeout Inattivit√† (minuti)</label>
                <select id="inactivityTimeout" onchange="saveSettings()">
                    <option value="1">1 minuto</option>
                    <option value="2">2 minuti</option>
                    <option value="5">5 minuti</option>
                    <option value="10">10 minuti</option>
                    <option value="15">15 minuti</option>
                    <option value="30">30 minuti</option>
                    <option value="0">Mai (non consigliato)</option>
                </select>
                <small style="color: #666; margin-top: 5px; display: block;">Tempo di inattivit√† prima del blocco automatico</small>
            </div>

            <div class="input-group">
                <label for="autoHideDelay">Durata Visualizzazione Dati (secondi)</label>
                <select id="autoHideDelay" onchange="saveSettings()">
                    <option value="5">5 secondi</option>
                    <option value="10">10 secondi</option>
                    <option value="15">15 secondi</option>
                    <option value="30">30 secondi</option>
                    <option value="0">Mai (rimane visibile)</option>
                </select>
                <small style="color: #666; margin-top: 5px; display: block;">Tempo dopo il quale i dati sensibili vengono nascosti automaticamente</small>
            </div>

            <div class="input-group">
                <label for="clipboardClearDelay">Cancellazione Automatica Appunti (secondi)</label>
                <select id="clipboardClearDelay" onchange="saveSettings()">
                    <option value="15">15 secondi</option>
                    <option value="30">30 secondi</option>
                    <option value="60">60 secondi</option>
                    <option value="120">2 minuti</option>
                    <option value="0">Mai (non cancellare)</option>
                </select>
                <small style="color: #666; margin-top: 5px; display: block;">Tempo dopo il quale gli appunti vengono cancellati automaticamente</small>
            </div>

            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="showPasswordStrength" onchange="saveSettings()" style="width: auto;">
                    <span>Mostra indicatore forza password</span>
                </label>
            </div>

            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="confirmDelete" onchange="saveSettings()" style="width: auto;">
                    <span>Conferma prima di eliminare</span>
                </label>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 15px; color: #dc3545;">‚ö†Ô∏è Zona Pericolosa</h3>
                <button class="btn btn-danger" onclick="changePassword()" style="margin-bottom: 10px;">Cambia Password Master</button>
                <button class="btn btn-danger" onclick="deleteAllData()">Elimina Tutti i Dati</button>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSettings()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div class="modal" id="instructionsModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 class="modal-header">üìñ Libretto Istruzioni - SMEMOPASS</h2>
            
            <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                
                <!-- Introduzione -->
                <div style="margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                    <h3 style="margin: 0 0 10px 0;">Benvenuto in SMEMOPASS! üîê</h3>
                    <p style="margin: 0; font-size: 0.95em;">Il tuo gestore di password sicuro e offline con crittografia AES-256. Tutti i tuoi dati sono protetti e rimangono solo sul tuo dispositivo.</p>
                </div>

                <!-- Primi Passi -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üöÄ Primi Passi</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>1. Prima Configurazione</strong><br>
                        Al primo utilizzo, clicca su "Prima configurazione" e crea una password master (minimo 8 caratteri). <strong>‚ö†Ô∏è Ricordala bene!</strong> Senza di essa non potrai accedere ai tuoi dati.
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong>2. Accesso</strong><br>
                        Inserisci la password master per accedere. L'app si bloccher√† automaticamente dopo un periodo di inattivit√† (configurabile nelle impostazioni).
                    </div>
                </div>

                <!-- Dashboard -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üìä Dashboard</h3>
                    <p>La dashboard mostra una panoramica della tua sicurezza:</p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                        <li><strong>Statistiche:</strong> Password totali, informazioni salvate, password deboli e duplicate</li>
                        <li><strong>Problemi di Sicurezza:</strong> Identifica password deboli o duplicate con link diretto per aggiornarle</li>
                        <li><strong>Password Vecchie:</strong> Segnala password non aggiornate da 6+ mesi</li>
                        <li><strong>Distribuzione Categorie:</strong> Grafico delle tue password per categoria</li>
                    </ul>
                </div>

                <!-- Sezione Password -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üîê Sezione Password</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Aggiungere una Password</strong><br>
                        1. Clicca "+ Aggiungi"<br>
                        2. Compila: Titolo, Categoria, Username/Email, Password, URL, Note<br>
                        3. Usa il <strong>Generatore Password</strong> per creare password sicure<br>
                        4. L'indicatore di forza ti aiuta a valutare la sicurezza<br>
                        5. Clicca "Salva"
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Gestire le Password</strong><br>
                        ‚Ä¢ <strong>üìã Copia:</strong> Copia la password negli appunti (si cancella automaticamente dopo 30 sec)<br>
                        ‚Ä¢ <strong>üëÅÔ∏è Mostra:</strong> Visualizza la password (si nasconde automaticamente dopo 10 sec)<br>
                        ‚Ä¢ <strong>‚úèÔ∏è Modifica:</strong> Aggiorna i dati della password<br>
                        ‚Ä¢ <strong>üóëÔ∏è Elimina:</strong> Rimuove la password (con conferma)
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong>Ricerca e Filtri</strong><br>
                        ‚Ä¢ Usa la barra di ricerca per trovare rapidamente una password<br>
                        ‚Ä¢ Filtra per categoria usando il menu a tendina<br>
                        ‚Ä¢ Gestisci le categorie con il pulsante "üìÅ Categorie"
                    </div>
                </div>

                <!-- Sezione Memoria Digitale -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üíæ Memoria Digitale</h3>
                    <p>Salva informazioni importanti che non sono password:</p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                        <li><strong>Documenti Personali:</strong> Codice fiscale, numero passaporto, patente</li>
                        <li><strong>Dati Bancari:</strong> IBAN, numero conto, carte di credito</li>
                        <li><strong>Dati Fiscali:</strong> Partita IVA, codice destinatario, PEC</li>
                        <li><strong>Assicurazioni:</strong> Numeri polizza</li>
                        <li><strong>Abbonamenti:</strong> Codici cliente, contratti</li>
                    </ul>
                    <p style="margin-top: 10px; color: #666;">Funziona esattamente come le password: aggiungi, cerca, copia e modifica con gli stessi strumenti.</p>
                </div>

                <!-- Categorie -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üìÅ Gestione Categorie</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        Clicca "üìÅ Categorie" per:<br>
                        ‚Ä¢ Aggiungere categorie personalizzate<br>
                        ‚Ä¢ Visualizzare tutte le categorie (predefinite in blu)<br>
                        ‚Ä¢ Eliminare categorie non utilizzate<br>
                        <br>
                        <em style="color: #666;">Le categorie predefinite non possono essere eliminate.</em>
                    </div>
                </div>

                <!-- Backup -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üíæ Backup e Sincronizzazione</h3>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 10px;">
                        <strong>‚ö†Ô∏è Importante:</strong> Esegui backup regolari! Se perdi il dispositivo o disinstalli l'app, perderai tutti i dati.
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Export (Backup)</strong><br>
                        ‚Ä¢ Clicca "Export" nell'header<br>
                        ‚Ä¢ Scarica un file JSON crittografato<br>
                        ‚Ä¢ Salvalo in un posto sicuro (cloud, PC, ecc.)<br>
                        ‚Ä¢ Il file √® protetto dalla tua password master
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong>Import (Ripristino)</strong><br>
                        ‚Ä¢ Clicca "Import" nell'header<br>
                        ‚Ä¢ Seleziona il file di backup<br>
                        ‚Ä¢ ‚ö†Ô∏è Sostituisce tutti i dati attuali<br>
                        ‚Ä¢ Richiede la password master originale
                    </div>
                </div>

                <!-- Impostazioni -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">‚öôÔ∏è Impostazioni</h3>
                    <p>Personalizza SMEMOPASS secondo le tue esigenze:</p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                        <li><strong>Timeout Inattivit√†:</strong> Tempo prima del blocco automatico (1-30 min o mai)</li>
                        <li><strong>Durata Visualizzazione:</strong> Quanto tempo rimangono visibili i dati sensibili (5-30 sec)</li>
                        <li><strong>Cancellazione Appunti:</strong> Quando cancellare automaticamente gli appunti (15 sec - 2 min)</li>
                        <li><strong>Indicatore Forza Password:</strong> Mostra/nascondi l'indicatore di sicurezza</li>
                        <li><strong>Conferma Eliminazione:</strong> Chiedi conferma prima di eliminare</li>
                    </ul>
                </div>

                <!-- Sicurezza -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üõ°Ô∏è Sicurezza e Privacy</h3>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong>‚úÖ I tuoi dati sono al sicuro:</strong><br>
                        ‚Ä¢ Crittografia AES-256 (standard militare)<br>
                        ‚Ä¢ Password master mai salvata<br>
                        ‚Ä¢ 100.000 iterazioni PBKDF2<br>
                        ‚Ä¢ Tutto offline, nessun server<br>
                        ‚Ä¢ Codice open source verificabile
                    </div>
                </div>

                <!-- Zone Pericolose -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è Zona Pericolosa</h3>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 10px;">
                        <strong>Cambia Password Master</strong><br>
                        Permette di cambiare la password master. Tutti i dati verranno automaticamente ri-crittografati con la nuova password. Richiede la password attuale.
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong>Elimina Tutti i Dati</strong><br>
                        ‚ö†Ô∏è <strong>ATTENZIONE:</strong> Cancellazione permanente e irreversibile di tutti i dati! Richiede conferma digitando "ELIMINA TUTTO".
                    </div>
                </div>

                <!-- Consigli -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üí° Consigli per l'Uso</h3>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                        <li>‚úÖ Usa password diverse per ogni account</li>
                        <li>‚úÖ Sfrutta il generatore per password sicure</li>
                        <li>‚úÖ Fai backup regolari (almeno mensili)</li>
                        <li>‚úÖ Aggiorna le password vecchie quando la dashboard te lo segnala</li>
                        <li>‚úÖ Non condividere mai la tua password master</li>
                        <li>‚úÖ Usa categorie per organizzare meglio</li>
                        <li>‚ö†Ô∏è Non salvare la password master nel telefono</li>
                    </ul>
                </div>

                <!-- FAQ -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">‚ùì Domande Frequenti</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Q: Ho dimenticato la password master, cosa faccio?</strong><br>
                        A: Purtroppo non c'√® modo di recuperarla. Dovrai resettare l'app e perdere tutti i dati. Per questo √® fondamentale fare backup regolari!
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Q: I miei dati sono visibili nel codice?</strong><br>
                        A: No! Tutti i dati sono crittografati. Anche aprendo il file HTML o il localStorage del browser, i dati sono illeggibili senza la password master.
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>Q: Posso usare SMEMOPASS su pi√π dispositivi?</strong><br>
                        A: S√¨! Esporta i dati da un dispositivo e importali nell'altro. Ricorda di fare export dopo ogni modifica importante.
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <strong>Q: √à sicuro salvare dati bancari?</strong><br>
                        A: S√¨! La crittografia AES-256 √® lo stesso standard usato da banche e governi. Finch√© mantieni sicura la password master, i tuoi dati sono protetti.
                    </div>
                </div>

            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeInstructions()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Global variables
        let masterKey = null;
        let currentEditId = null;
        let currentMemoryEditId = null;
        let currentCategoryType = 'password'; // 'password' or 'memory'
        let inactivityTimer = null;
        let currentTab = 'passwords';
        let settings = {
            inactivityTimeout: 5,
            autoHideDelay: 10,
            clipboardClearDelay: 30,
            showPasswordStrength: true,
            confirmDelete: true
        };
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // Will be overridden by settings
        
        // Default categories for passwords (alphabetical order)
        const DEFAULT_PASSWORD_CATEGORIES = ['Applicazioni', 'Banking', 'Dispositivi elettronici', 'Email', 'Piattaforme Web', 'Social'];
        
        // Default categories for digital memory
        const DEFAULT_MEMORY_CATEGORIES = ['Abbonamenti', 'Assicurazioni', 'Dati Bancari', 'Dati Fiscali', 'Documenti Personali', 'Altro'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings
            const savedSettings = localStorage.getItem('passwordManager_settings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
            
            // Initialize password categories if not exists
            if (!localStorage.getItem('passwordManager_categories')) {
                localStorage.setItem('passwordManager_categories', JSON.stringify(DEFAULT_PASSWORD_CATEGORIES));
            }
            
            // Initialize memory categories if not exists
            if (!localStorage.getItem('passwordManager_memoryCategories')) {
                localStorage.setItem('passwordManager_memoryCategories', JSON.stringify(DEFAULT_MEMORY_CATEGORIES));
            }
            
            // Initialize memory data if not exists
            if (!localStorage.getItem('passwordManager_memoryData')) {
                localStorage.setItem('passwordManager_memoryData', JSON.stringify([]));
            triggerBackupReminder();
            }
            
            // Set up inactivity timer
            resetInactivityTimer();
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('scroll', resetInactivityTimer);
            
            // PWA Install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button if not already installed
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    showInstallPrompt(deferredPrompt);
                }
            });
            
            // Check if already installed
            window.addEventListener('appinstalled', () => {
                console.log('SMEMOPASS installato con successo!');
            });
        });

        function showInstallPrompt(deferredPrompt) {
            // Check if user already dismissed the prompt
            if (localStorage.getItem('installPromptDismissed')) return;
            
            // Create install banner (only show once after first login)
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 3000;
                display: flex;
                gap: 15px;
                align-items: center;
                max-width: 90%;
                animation: slideUp 0.3s ease;
            `;
            
            banner.innerHTML = `
                <div style="flex: 1;">
                    <strong>üì± Installa SMEMOPASS</strong><br>
                    <small>Aggiungi l'app alla tua home screen</small>
                </div>
                <button onclick="installPWA()" style="background: white; color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    Installa
                </button>
                <button onclick="dismissInstallPrompt()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    ‚úï
                </button>
            `;
            
            // Only show after successful login
            setTimeout(() => {
                if (masterKey) {
                    document.body.appendChild(banner);
                    window.installBanner = banner;
                    window.deferredPrompt = deferredPrompt;
                }
            }, 3000);
        }

        async function installPWA() {
            const deferredPrompt = window.deferredPrompt;
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showToast('SMEMOPASS verr√† installata!', 'success');
            }
            
            window.deferredPrompt = null;
            if (window.installBanner) {
                window.installBanner.remove();
            }
        }

        function dismissInstallPrompt() {
            localStorage.setItem('installPromptDismissed', 'true');
            if (window.installBanner) {
                window.installBanner.remove();
            }
        }

        // Inactivity auto-lock
        function resetInactivityTimer() {
            if (masterKey && settings.inactivityTimeout > 0) {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    logout();
                    showToast('Sessione scaduta per inattivit√†', 'error');
                }, settings.inactivityTimeout * 60 * 1000);
            }
        }

        // Crypto functions
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encrypt(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            
            const result = new Uint8Array(iv.length + encrypted.byteLength);
            result.set(iv, 0);
            result.set(new Uint8Array(encrypted), iv.length);
            
            return btoa(String.fromCharCode(...result));
        }

        async function decrypt(encryptedText, key) {
            try {
                const data = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encrypted
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (e) {
                throw new Error('Decrittazione fallita');
            }
        }

        // First time setup
        function showFirstTimeSetup() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'block';
        }

        function backToLogin() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('setupPassword').value = '';
            document.getElementById('setupPasswordConfirm').value = '';
        }

        function completeSetup() {
            const password = document.getElementById('setupPassword').value;
            const confirmPassword = document.getElementById('setupPasswordConfirm').value;
            
            if (!password || password.length < 8) {
                showToast('La password deve essere di almeno 8 caratteri', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Le password non coincidono', 'error');
                return;
            }
            
            // Initialize storage
            const salt = crypto.getRandomValues(new Uint8Array(16));
            localStorage.setItem('passwordManager_salt', btoa(String.fromCharCode(...salt)));
            localStorage.setItem('passwordManager_initialized', 'true');
            localStorage.setItem('passwordManager_data', JSON.stringify([]));
            triggerBackupReminder();
            
            // Clear fields
            document.getElementById('setupPassword').value = '';
            document.getElementById('setupPasswordConfirm').value = '';
            
            // Go back to login
            backToLogin();
            
            showToast('Configurazione completata! Ora puoi accedere.', 'success');
        }

        // Login
        async function login() {
            const password = document.getElementById('masterPassword').value;
            
            if (!password) {
                showToast('Inserisci la password', 'error');
                return;
            }
            
            if (!localStorage.getItem('passwordManager_initialized')) {
                showToast('Esegui prima la configurazione iniziale', 'error');
                return;
            }
            
            try {
                const saltStr = localStorage.getItem('passwordManager_salt');
                const salt = Uint8Array.from(atob(saltStr), c => c.charCodeAt(0));
                
                masterKey = await deriveKey(password, salt);
                
                // Try to decrypt data to verify password
                const encryptedData = localStorage.getItem('passwordManager_data');
                if (encryptedData && encryptedData !== '[]') {
                    try {
                        const data = JSON.parse(encryptedData);
                        if (data.length > 0) {
                            await decrypt(data[0].password, masterKey);
                        }
                    } catch (e) {
                        showToast('Password errata', 'error');
                        masterKey = null;
                        return;
                    }
                }
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('masterPassword').value = '';
                
                loadCategories();
                loadMemoryCategories();
                loadPasswords();
                loadMemory();
                loadDashboard();
                resetInactivityTimer();
                showToast('Accesso effettuato', 'success');
            } catch (e) {
                showToast('Errore durante l\'accesso', 'error');
            }
        }

        // Logout
        function logout() {
            masterKey = null;
            currentEditId = null;
            currentMemoryEditId = null;
            clearTimeout(inactivityTimer);
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('passwordList').innerHTML = '';
            document.getElementById('memoryList').innerHTML = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchMemoryInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('memoryCategoryFilter').value = '';
            
            // Reset to dashboard tab
            switchTab('dashboard');
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'dashboard') {
                document.getElementById('dashboardSection').classList.add('active');
                loadDashboard(); // Refresh dashboard data
            } else if (tab === 'passwords') {
                document.getElementById('passwordSection').classList.add('active');
            } else if (tab === 'memory') {
                document.getElementById('memorySection').classList.add('active');
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            const passwordData = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
            const memoryData = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
            
            // Update statistics
            document.getElementById('totalPasswords').textContent = passwordData.length;
            document.getElementById('totalMemory').textContent = memoryData.length;
            
            // Analyze passwords
            const analysis = await analyzePasswords(passwordData);
            
            document.getElementById('weakPasswords').textContent = analysis.weak.length;
            document.getElementById('duplicatePasswords').textContent = analysis.duplicates.length;
            
            // Display security issues
            displaySecurityIssues(analysis);
            
            // Display old passwords
            displayOldPasswords(analysis.old);
            
            // Display category distribution
            displayCategoryChart(passwordData, memoryData);
        }

        async function analyzePasswords(passwordData) {
            const weak = [];
            const duplicates = [];
            const old = [];
            const passwordMap = new Map();
            
            for (const entry of passwordData) {
                try {
                    const decryptedPassword = await decrypt(entry.password, masterKey);
                    
                    // Check password strength
                    const strength = calculatePasswordStrength(decryptedPassword);
                    if (strength <= 2) {
                        weak.push({ ...entry, decryptedPassword });
                    }
                    
                    // Check for duplicates
                    if (passwordMap.has(decryptedPassword)) {
                        const existing = passwordMap.get(decryptedPassword);
                        if (!duplicates.find(d => d.password === decryptedPassword)) {
                            duplicates.push({
                                password: decryptedPassword,
                                entries: [existing, entry]
                            });
                        } else {
                            const dup = duplicates.find(d => d.password === decryptedPassword);
                            dup.entries.push(entry);
                        }
                    } else {
                        passwordMap.set(decryptedPassword, entry);
                    }
                    
                    // Check password age (6+ months old)
                    const updatedDate = new Date(entry.updatedAt || entry.createdAt);
                    const sixMonthsAgo = new Date();
                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                    
                    if (updatedDate < sixMonthsAgo) {
                        old.push(entry);
                    }
                } catch (e) {
                    console.error('Error analyzing password:', e);
                }
            }
            
            return { weak, duplicates, old };
        }

        function calculatePasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            return strength;
        }

        function displaySecurityIssues(analysis) {
            const container = document.getElementById('securityIssues');
            container.innerHTML = '';
            
            if (analysis.weak.length === 0 && analysis.duplicates.length === 0) {
                container.innerHTML = `
                    <div class="empty-dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3>Nessun problema rilevato! üéâ</h3>
                        <p>Tutte le tue password sono sicure</p>
                    </div>
                `;
                return;
            }
            
            // Weak passwords
            analysis.weak.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'issue-item';
                item.innerHTML = `
                    <div class="issue-content">
                        <div class="issue-title">‚ö†Ô∏è Password Debole: ${escapeHtml(entry.title)}</div>
                        <div class="issue-description">Questa password √® troppo semplice e dovrebbe essere cambiata</div>
                    </div>
                    <button class="issue-action" onclick="editEntryFromDashboard('${entry.id}')">Aggiorna</button>
                `;
                container.appendChild(item);
            });
            
            // Duplicate passwords
            analysis.duplicates.forEach(dup => {
                const item = document.createElement('div');
                item.className = 'issue-item warning';
                const titles = dup.entries.map(e => e.title).join(', ');
                item.innerHTML = `
                    <div class="issue-content">
                        <div class="issue-title">üîÑ Password Duplicata</div>
                        <div class="issue-description">Usata in ${dup.entries.length} account: ${escapeHtml(titles)}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function displayOldPasswords(oldPasswords) {
            const container = document.getElementById('oldPasswords');
            container.innerHTML = '';
            
            if (oldPasswords.length === 0) {
                container.innerHTML = `
                    <div class="empty-dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3>Tutte le password sono recenti! ‚úÖ</h3>
                    </div>
                `;
                return;
            }
            
            oldPasswords.forEach(entry => {
                const updatedDate = new Date(entry.updatedAt || entry.createdAt);
                const monthsOld = Math.floor((Date.now() - updatedDate) / (1000 * 60 * 60 * 24 * 30));
                
                const item = document.createElement('div');
                item.className = 'issue-item info';
                item.innerHTML = `
                    <div class="issue-content">
                        <div class="issue-title">‚è∞ ${escapeHtml(entry.title)}</div>
                        <div class="issue-description">Non aggiornata da ${monthsOld} mesi</div>
                    </div>
                    <button class="issue-action" onclick="editEntryFromDashboard('${entry.id}')">Aggiorna</button>
                `;
                container.appendChild(item);
            });
        }

        function displayCategoryChart(passwordData, memoryData) {
            const container = document.getElementById('categoryChart');
            container.innerHTML = '';
            
            // Count by category
            const categoryCounts = {};
            
            passwordData.forEach(entry => {
                categoryCounts[entry.category] = (categoryCounts[entry.category] || 0) + 1;
            });
            
            memoryData.forEach(entry => {
                categoryCounts[entry.category] = (categoryCounts[entry.category] || 0) + 1;
            });
            
            if (Object.keys(categoryCounts).length === 0) {
                container.innerHTML = `
                    <div class="empty-dashboard">
                        <p>Nessun dato disponibile</p>
                    </div>
                `;
                return;
            }
            
            const maxCount = Math.max(...Object.values(categoryCounts));
            
            // Sort by count descending
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1]);
            
            sortedCategories.forEach(([category, count]) => {
                const percentage = (count / maxCount) * 100;
                
                const barContainer = document.createElement('div');
                barContainer.className = 'category-bar-container';
                barContainer.innerHTML = `
                    <div class="category-bar-label">${escapeHtml(category)}</div>
                    <div class="category-bar-wrapper">
                        <div class="category-bar-fill" style="width: ${percentage}%">${count}</div>
                    </div>
                `;
                container.appendChild(barContainer);
            });
        }

        function editEntryFromDashboard(id) {
            // Switch to passwords tab and edit
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(btn => btn.classList.remove('active'));
            tabs[1].classList.add('active'); // Password tab
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('passwordSection').classList.add('active');
            
            // Edit the entry
            setTimeout(() => editEntry(id), 100);
        }

        // Category Management
        function loadCategories() {
            const categories = JSON.parse(localStorage.getItem('passwordManager_categories') || JSON.stringify(DEFAULT_PASSWORD_CATEGORIES));
            
            // Update filter dropdown
            const filterSelect = document.getElementById('categoryFilter');
            filterSelect.innerHTML = '<option value="">Tutte le categorie</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterSelect.appendChild(option);
            });
            
            // Update entry category dropdown
            const entrySelect = document.getElementById('entryCategory');
            entrySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                entrySelect.appendChild(option);
            });
        }

        function loadMemoryCategories() {
            const categories = JSON.parse(localStorage.getItem('passwordManager_memoryCategories') || JSON.stringify(DEFAULT_MEMORY_CATEGORIES));
            
            // Update filter dropdown
            const filterSelect = document.getElementById('memoryCategoryFilter');
            filterSelect.innerHTML = '<option value="">Tutte le categorie</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterSelect.appendChild(option);
            });
            
            // Update memory entry category dropdown
            const entrySelect = document.getElementById('memoryCategory');
            entrySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                entrySelect.appendChild(option);
            });
        }

        function showCategoryManager(type) {
            currentCategoryType = type;
            const isPassword = type === 'password';
            
            const storageKey = isPassword ? 'passwordManager_categories' : 'passwordManager_memoryCategories';
            const defaultCategories = isPassword ? DEFAULT_PASSWORD_CATEGORIES : DEFAULT_MEMORY_CATEGORIES;
            
            const categories = JSON.parse(localStorage.getItem(storageKey) || JSON.stringify(defaultCategories));
            const categoryList = document.getElementById('categoryList');
            
            document.getElementById('categoryModalTitle').textContent = isPassword ? 'Gestione Categorie Password' : 'Gestione Categorie Memoria';
            
            categoryList.innerHTML = '';
            categories.forEach(cat => {
                const isDefault = defaultCategories.includes(cat);
                const item = document.createElement('div');
                item.className = 'category-item' + (isDefault ? ' default' : '');
                
                item.innerHTML = `
                    <div>
                        <span class="category-item-name">${escapeHtml(cat)}</span>
                        ${isDefault ? '<span class="category-item-badge">Default</span>' : ''}
                    </div>
                    ${!isDefault ? `<button class="btn-delete-category" onclick="deleteCategory('${escapeHtml(cat)}')">Elimina</button>` : ''}
                `;
                
                categoryList.appendChild(item);
            });
            
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryName').value = '';
        }

        function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                showToast('Inserisci un nome per la categoria', 'error');
                return;
            }
            
            const isPassword = currentCategoryType === 'password';
            const storageKey = isPassword ? 'passwordManager_categories' : 'passwordManager_memoryCategories';
            const defaultCategories = isPassword ? DEFAULT_PASSWORD_CATEGORIES : DEFAULT_MEMORY_CATEGORIES;
            
            const categories = JSON.parse(localStorage.getItem(storageKey) || JSON.stringify(defaultCategories));
            
            if (categories.includes(categoryName)) {
                showToast('Questa categoria esiste gi√†', 'error');
                return;
            }
            
            categories.push(categoryName);
            categories.sort(); // Keep alphabetical order
            localStorage.setItem(storageKey, JSON.stringify(categories));
            
            document.getElementById('newCategoryName').value = '';
            
            if (isPassword) {
                loadCategories();
            } else {
                loadMemoryCategories();
            }
            
            showCategoryManager(currentCategoryType); // Refresh the list
            showToast('Categoria aggiunta', 'success');
        }

        function deleteCategory(categoryName) {
            const isPassword = currentCategoryType === 'password';
            const dataKey = isPassword ? 'passwordManager_data' : 'passwordManager_memoryData';
            const storageKey = isPassword ? 'passwordManager_categories' : 'passwordManager_memoryCategories';
            const defaultCategories = isPassword ? DEFAULT_PASSWORD_CATEGORIES : DEFAULT_MEMORY_CATEGORIES;
            
            // Check if any entries use this category
            const data = JSON.parse(localStorage.getItem(dataKey) || '[]');
            const usedCount = data.filter(entry => entry.category === categoryName).length;
            
            if (usedCount > 0) {
                showToast(`Impossibile eliminare: ${usedCount} ${isPassword ? 'password usano' : 'informazioni usano'} questa categoria`, 'error');
                return;
            }
            
            if (!confirm(`Eliminare la categoria "${categoryName}"?`)) {
                return;
            }
            
            let categories = JSON.parse(localStorage.getItem(storageKey) || JSON.stringify(defaultCategories));
            categories = categories.filter(cat => cat !== categoryName);
            
            localStorage.setItem(storageKey, JSON.stringify(categories));
            
            if (isPassword) {
                loadCategories();
            } else {
                loadMemoryCategories();
            }
            
            showCategoryManager(currentCategoryType); // Refresh the list
            showToast('Categoria eliminata', 'success');
        }

        // Load and display passwords
        async function loadPasswords() {
            const data = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
            const container = document.getElementById('passwordList');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <h3>Nessuna password salvata</h3>
                        <p>Clicca su "Aggiungi" per iniziare</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            for (const entry of data) {
                const card = await createPasswordCard(entry);
                container.appendChild(card);
            }
        }

        // Create password card
        async function createPasswordCard(entry) {
            const card = document.createElement('div');
            card.className = 'password-card';
            card.dataset.id = entry.id;
            card.dataset.category = entry.category;
            card.dataset.searchtext = `${entry.title} ${entry.username || ''} ${entry.email || ''} ${entry.url || ''}`.toLowerCase();
            
            const decryptedPassword = await decrypt(entry.password, masterKey);
            
            card.innerHTML = `
                <div class="password-card-header">
                    <div>
                        <div class="password-card-title">${escapeHtml(entry.title)}</div>
                        <span class="password-card-category">${escapeHtml(entry.category)}</span>
                    </div>
                </div>
                <div class="password-card-info">
                    ${entry.username ? `<div><strong>Username:</strong> ${escapeHtml(entry.username)}</div>` : ''}
                    ${entry.email ? `<div><strong>Email:</strong> ${escapeHtml(entry.email)}</div>` : ''}
                    ${entry.url ? `<div><strong>URL:</strong> <a href="${escapeHtml(entry.url)}" target="_blank">${escapeHtml(entry.url)}</a></div>` : ''}
                    <div><strong>Password:</strong> <span id="pwd-${entry.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                    ${entry.notes ? `<div><strong>Note:</strong> ${escapeHtml(entry.notes)}</div>` : ''}
                </div>
                <div class="password-card-actions">
                    <button class="icon-btn btn-copy" onclick="copyPassword('${entry.id}', '${escapeHtml(decryptedPassword)}')">üìã Copia</button>
                    <button class="icon-btn btn-show" onclick="togglePassword('${entry.id}', '${escapeHtml(decryptedPassword)}')">üëÅÔ∏è Mostra</button>
                    <button class="icon-btn btn-edit" onclick="editEntry('${entry.id}')">‚úèÔ∏è Modifica</button>
                    <button class="icon-btn btn-delete" onclick="deleteEntry('${entry.id}')">üóëÔ∏è Elimina</button>
                </div>
            `;
            
            return card;
        }

        // Filter passwords
        function filterPasswords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const cards = document.querySelectorAll('.password-card');
            
            cards.forEach(card => {
                const matchesSearch = card.dataset.searchtext.includes(searchTerm);
                const matchesCategory = !category || card.dataset.category === category;
                
                card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
            });
        }

        // Show/hide password
        function togglePassword(id, password) {
            const span = document.getElementById(`pwd-${id}`);
            if (span.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                span.textContent = password;
                if (settings.autoHideDelay > 0) {
                    setTimeout(() => {
                        span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }, settings.autoHideDelay * 1000);
                }
            } else {
                span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }

        // Copy password
        async function copyPassword(id, password) {
            try {
                await navigator.clipboard.writeText(password);
                showToast('Password copiata!', 'success');
                
                // Clear clipboard after configured time
                if (settings.clipboardClearDelay > 0) {
                    setTimeout(async () => {
                        await navigator.clipboard.writeText('');
                    }, settings.clipboardClearDelay * 1000);
                }
            } catch (e) {
                showToast('Errore durante la copia', 'error');
            }
        }

        // Show add modal
        function showAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Aggiungi Password';
            clearModalFields();
            document.getElementById('addEditModal').classList.add('active');
        }

        // Edit entry
        async function editEntry(id) {
            const data = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
            const entry = data.find(e => e.id === id);
            
            if (!entry) return;
            
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Modifica Password';
            
            document.getElementById('entryTitle').value = entry.title;
            document.getElementById('entryCategory').value = entry.category;
            document.getElementById('entryUsername').value = entry.username || '';
            document.getElementById('entryEmail').value = entry.email || '';
            document.getElementById('entryPassword').value = await decrypt(entry.password, masterKey);
            document.getElementById('entryUrl').value = entry.url || '';
            document.getElementById('entryNotes').value = entry.notes || '';
            
            document.getElementById('addEditModal').classList.add('active');
            checkPasswordStrength();
        }

        // Save entry
        async function saveEntry() {
            const title = document.getElementById('entryTitle').value.trim();
            const category = document.getElementById('entryCategory').value;
            const username = document.getElementById('entryUsername').value.trim();
            const email = document.getElementById('entryEmail').value.trim();
            const password = document.getElementById('entryPassword').value;
            const url = document.getElementById('entryUrl').value.trim();
            const notes = document.getElementById('entryNotes').value.trim();
            
            if (!title || !password) {
                showToast('Titolo e password sono obbligatori', 'error');
                return;
            }
            
            const data = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
            const encryptedPassword = await encrypt(password, masterKey);
            
            if (currentEditId) {
                // Edit existing
                const index = data.findIndex(e => e.id === currentEditId);
                if (index !== -1) {
                    data[index] = {
                        ...data[index],
                        title,
                        category,
                        username,
                        email,
                        password: encryptedPassword,
                        url,
                        notes,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Add new
                data.push({
                    id: Date.now().toString(),
                    title,
                    category,
                    username,
                    email,
                    password: encryptedPassword,
                    url,
                    notes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('passwordManager_data', JSON.stringify(data));
            triggerBackupReminder();
            closeModal();
            loadPasswords();
            if (currentTab === 'dashboard') loadDashboard();
            showToast(currentEditId ? 'Password aggiornata' : 'Password aggiunta', 'success');
        }

        // Delete entry
        function deleteEntry(id) {
            if (settings.confirmDelete && !confirm('Sei sicuro di voler eliminare questa password?')) return;
            
            let data = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
            data = data.filter(e => e.id !== id);
            
            localStorage.setItem('passwordManager_data', JSON.stringify(data));
            triggerBackupReminder();
            loadPasswords();
            if (currentTab === 'dashboard') loadDashboard();
            showToast('Password eliminata', 'success');
        }

        // Memory Management Functions
        async function loadMemory() {
            const data = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
            const container = document.getElementById('memoryList');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M2 12h20M6 6h12v12H6z"></path>
                        </svg>
                        <h3>Nessuna informazione salvata</h3>
                        <p>Clicca su "Aggiungi" per iniziare</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            for (const entry of data) {
                const card = await createMemoryCard(entry);
                container.appendChild(card);
            }
        }

        async function createMemoryCard(entry) {
            const card = document.createElement('div');
            card.className = 'password-card';
            card.dataset.id = entry.id;
            card.dataset.category = entry.category;
            card.dataset.searchtext = `${entry.title} ${entry.additionalInfo || ''} ${entry.notes || ''}`.toLowerCase();
            
            const decryptedData = await decrypt(entry.data, masterKey);
            
            card.innerHTML = `
                <div class="password-card-header">
                    <div>
                        <div class="password-card-title">${escapeHtml(entry.title)}</div>
                        <span class="password-card-category">${escapeHtml(entry.category)}</span>
                    </div>
                </div>
                <div class="password-card-info">
                    <div><strong>Informazione:</strong> <span id="mem-${entry.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                    ${entry.additionalInfo ? `<div><strong>Dettagli:</strong> ${escapeHtml(entry.additionalInfo)}</div>` : ''}
                    ${entry.notes ? `<div><strong>Note:</strong> ${escapeHtml(entry.notes)}</div>` : ''}
                </div>
                <div class="password-card-actions">
                    <button class="icon-btn btn-copy" onclick="copyMemoryData('${entry.id}', '${escapeHtml(decryptedData)}')">üìã Copia</button>
                    <button class="icon-btn btn-show" onclick="toggleMemoryData('${entry.id}', '${escapeHtml(decryptedData)}')">üëÅÔ∏è Mostra</button>
                    <button class="icon-btn btn-edit" onclick="editMemoryEntry('${entry.id}')">‚úèÔ∏è Modifica</button>
                    <button class="icon-btn btn-delete" onclick="deleteMemoryEntry('${entry.id}')">üóëÔ∏è Elimina</button>
                </div>
            `;
            
            return card;
        }

        function filterMemory() {
            const searchTerm = document.getElementById('searchMemoryInput').value.toLowerCase();
            const category = document.getElementById('memoryCategoryFilter').value;
            const cards = document.querySelectorAll('#memoryList .password-card');
            
            cards.forEach(card => {
                const matchesSearch = card.dataset.searchtext.includes(searchTerm);
                const matchesCategory = !category || card.dataset.category === category;
                
                card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
            });
        }

        function toggleMemoryData(id, data) {
            const span = document.getElementById(`mem-${id}`);
            if (span.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                span.textContent = data;
                if (settings.autoHideDelay > 0) {
                    setTimeout(() => {
                        span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }, settings.autoHideDelay * 1000);
                }
            } else {
                span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }

        async function copyMemoryData(id, data) {
            try {
                await navigator.clipboard.writeText(data);
                showToast('Informazione copiata!', 'success');
                
                if (settings.clipboardClearDelay > 0) {
                    setTimeout(async () => {
                        await navigator.clipboard.writeText('');
                    }, settings.clipboardClearDelay * 1000);
                }
            } catch (e) {
                showToast('Errore durante la copia', 'error');
            }
        }

        function showAddMemoryModal() {
            currentMemoryEditId = null;
            document.getElementById('memoryModalTitle').textContent = 'Aggiungi Informazione';
            clearMemoryModalFields();
            document.getElementById('addEditMemoryModal').classList.add('active');
        }

        async function editMemoryEntry(id) {
            const data = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
            const entry = data.find(e => e.id === id);
            
            if (!entry) return;
            
            currentMemoryEditId = id;
            document.getElementById('memoryModalTitle').textContent = 'Modifica Informazione';
            
            document.getElementById('memoryTitle').value = entry.title;
            document.getElementById('memoryCategory').value = entry.category;
            document.getElementById('memoryData').value = await decrypt(entry.data, masterKey);
            document.getElementById('memoryAdditionalInfo').value = entry.additionalInfo || '';
            document.getElementById('memoryNotes').value = entry.notes || '';
            
            document.getElementById('addEditMemoryModal').classList.add('active');
        }

        async function saveMemoryEntry() {
            const title = document.getElementById('memoryTitle').value.trim();
            const category = document.getElementById('memoryCategory').value;
            const data = document.getElementById('memoryData').value.trim();
            const additionalInfo = document.getElementById('memoryAdditionalInfo').value.trim();
            const notes = document.getElementById('memoryNotes').value.trim();
            
            if (!title || !data) {
                showToast('Titolo e informazione sono obbligatori', 'error');
                return;
            }
            
            const memoryData = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
            const encryptedData = await encrypt(data, masterKey);
            
            if (currentMemoryEditId) {
                const index = memoryData.findIndex(e => e.id === currentMemoryEditId);
                if (index !== -1) {
                    memoryData[index] = {
                        ...memoryData[index],
                        title,
                        category,
                        data: encryptedData,
                        additionalInfo,
                        notes,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                memoryData.push({
                    id: Date.now().toString(),
                    title,
                    category,
                    data: encryptedData,
                    additionalInfo,
                    notes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('passwordManager_memoryData', JSON.stringify(memoryData));
            triggerBackupReminder();
            closeMemoryModal();
            loadMemory();
            if (currentTab === 'dashboard') loadDashboard();
            showToast(currentMemoryEditId ? 'Informazione aggiornata' : 'Informazione aggiunta', 'success');
        }

        function deleteMemoryEntry(id) {
            if (settings.confirmDelete && !confirm('Sei sicuro di voler eliminare questa informazione?')) return;
            
            let data = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
            data = data.filter(e => e.id !== id);
            
            localStorage.setItem('passwordManager_memoryData', JSON.stringify(data));
            triggerBackupReminder();
            loadMemory();
            if (currentTab === 'dashboard') loadDashboard();
            showToast('Informazione eliminata', 'success');
        }

        function closeMemoryModal() {
            document.getElementById('addEditMemoryModal').classList.remove('active');
            clearMemoryModalFields();
        }

        function clearMemoryModalFields() {
            document.getElementById('memoryTitle').value = '';
            const categories = JSON.parse(localStorage.getItem('passwordManager_memoryCategories') || JSON.stringify(DEFAULT_MEMORY_CATEGORIES));
            if (categories.length > 0) {
                document.getElementById('memoryCategory').value = categories[0];
            }
            document.getElementById('memoryData').value = '';
            document.getElementById('memoryAdditionalInfo').value = '';
            document.getElementById('memoryNotes').value = '';
        }

        // Password generator
        function generatePassword() {
            const length = parseInt(document.getElementById('genLength').value);
            const useUppercase = document.getElementById('genUppercase').checked;
            const useLowercase = document.getElementById('genLowercase').checked;
            const useNumbers = document.getElementById('genNumbers').checked;
            const useSymbols = document.getElementById('genSymbols').checked;
            
            let charset = '';
            if (useUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (useLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (useNumbers) charset += '0123456789';
            if (useSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
            
            if (!charset) {
                showToast('Seleziona almeno un tipo di carattere', 'error');
                return '';
            }
            
            let password = '';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            
            for (let i = 0; i < length; i++) {
                password += charset[array[i] % charset.length];
            }
            
            return password;
        }

        function generateAndFillPassword() {
            const password = generatePassword();
            if (password) {
                document.getElementById('entryPassword').value = password;
                document.getElementById('generatedPasswordDisplay').textContent = password;
                document.getElementById('generatedPasswordDisplay').style.display = 'block';
                checkPasswordStrength();
            }
        }

        // Check password strength
        function checkPasswordStrength() {
            const password = document.getElementById('entryPassword').value;
            const bar = document.getElementById('strengthBar');
            
            if (!settings.showPasswordStrength) {
                bar.parentElement.style.display = 'none';
                return;
            }
            
            bar.parentElement.style.display = 'block';
            
            if (!password) {
                bar.className = 'password-strength-bar';
                return;
            }
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            if (strength <= 2) {
                bar.className = 'password-strength-bar strength-weak';
            } else if (strength <= 4) {
                bar.className = 'password-strength-bar strength-medium';
            } else {
                bar.className = 'password-strength-bar strength-strong';
            }
        }

        // Settings Management
        function showSettings() {
            document.getElementById('inactivityTimeout').value = settings.inactivityTimeout;
            document.getElementById('autoHideDelay').value = settings.autoHideDelay;
            document.getElementById('clipboardClearDelay').value = settings.clipboardClearDelay;
            document.getElementById('showPasswordStrength').checked = settings.showPasswordStrength;
            document.getElementById('confirmDelete').checked = settings.confirmDelete;
            
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function showInstructions() {
            document.getElementById('instructionsModal').classList.add('active');
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').classList.remove('active');
        }

        function saveSettings() {
            settings.inactivityTimeout = parseInt(document.getElementById('inactivityTimeout').value);
            settings.autoHideDelay = parseInt(document.getElementById('autoHideDelay').value);
            settings.clipboardClearDelay = parseInt(document.getElementById('clipboardClearDelay').value);
            settings.showPasswordStrength = document.getElementById('showPasswordStrength').checked;
            settings.confirmDelete = document.getElementById('confirmDelete').checked;
            
            localStorage.setItem('passwordManager_settings', JSON.stringify(settings));
            
            // Reset inactivity timer with new timeout
            resetInactivityTimer();
            
            showToast('Impostazioni salvate', 'success');
        }

        async function changePassword() {
            if (!confirm('Vuoi cambiare la password master? Dovrai reinserire la nuova password.')) {
                return;
            }
            
            const currentPassword = prompt('Inserisci la password master attuale:');
            if (!currentPassword) return;
            
            // Verify current password
            try {
                const saltStr = localStorage.getItem('passwordManager_salt');
                const salt = Uint8Array.from(atob(saltStr), c => c.charCodeAt(0));
                const testKey = await deriveKey(currentPassword, salt);
                
                // Try to decrypt some data to verify
                const data = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
                if (data.length > 0) {
                    await decrypt(data[0].password, testKey);
                }
            } catch (e) {
                showToast('Password attuale errata', 'error');
                return;
            }
            
            const newPassword = prompt('Inserisci la nuova password master (minimo 8 caratteri):');
            if (!newPassword || newPassword.length < 8) {
                showToast('La nuova password deve essere di almeno 8 caratteri', 'error');
                return;
            }
            
            const confirmPassword = prompt('Conferma la nuova password:');
            if (newPassword !== confirmPassword) {
                showToast('Le password non coincidono', 'error');
                return;
            }
            
            try {
                // Decrypt all data with old key
                const passwordData = JSON.parse(localStorage.getItem('passwordManager_data') || '[]');
                const memoryData = JSON.parse(localStorage.getItem('passwordManager_memoryData') || '[]');
                
                const decryptedPasswords = [];
                for (const entry of passwordData) {
                    decryptedPasswords.push({
                        ...entry,
                        password: await decrypt(entry.password, masterKey)
                    });
                }
                
                const decryptedMemory = [];
                for (const entry of memoryData) {
                    decryptedMemory.push({
                        ...entry,
                        data: await decrypt(entry.data, masterKey)
                    });
                }
                
                // Create new salt and key
                const newSalt = crypto.getRandomValues(new Uint8Array(16));
                const newKey = await deriveKey(newPassword, newSalt);
                
                // Re-encrypt all data with new key
                for (const entry of decryptedPasswords) {
                    entry.password = await encrypt(entry.password, newKey);
                }
                
                for (const entry of decryptedMemory) {
                    entry.data = await encrypt(entry.data, newKey);
                }
                
                // Save new salt and data
                localStorage.setItem('passwordManager_salt', btoa(String.fromCharCode(...newSalt)));
                localStorage.setItem('passwordManager_data', JSON.stringify(decryptedPasswords));
            triggerBackupReminder();
                localStorage.setItem('passwordManager_memoryData', JSON.stringify(decryptedMemory));
            triggerBackupReminder();
                
                masterKey = newKey;
                
                closeSettings();
                showToast('Password master cambiata con successo!', 'success');
            } catch (e) {
                showToast('Errore durante il cambio password: ' + e.message, 'error');
            }
        }

        function deleteAllData() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE! Questa operazione canceller√† TUTTI i tuoi dati in modo PERMANENTE.\n\nSei assolutamente sicuro?')) {
                return;
            }
            
            const confirmation = prompt('Digita "ELIMINA TUTTO" per confermare:');
            if (confirmation !== 'ELIMINA TUTTO') {
                showToast('Operazione annullata', 'error');
                return;
            }
            
            localStorage.removeItem('passwordManager_salt');
            localStorage.removeItem('passwordManager_initialized');
            localStorage.removeItem('passwordManager_data');
            localStorage.removeItem('passwordManager_memoryData');
            localStorage.removeItem('passwordManager_categories');
            localStorage.removeItem('passwordManager_memoryCategories');
            localStorage.removeItem('passwordManager_settings');
            
            closeSettings();
            logout();
            showToast('Tutti i dati sono stati eliminati', 'success');
        }

        // Export data
        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportData() {
            const passwordData = localStorage.getItem('passwordManager_data');
            const memoryData = localStorage.getItem('passwordManager_memoryData');
            const salt = localStorage.getItem('passwordManager_salt');
            const passwordCategories = localStorage.getItem('passwordManager_categories');
            const memoryCategories = localStorage.getItem('passwordManager_memoryCategories');
            
            const exportObj = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                salt: salt,
                passwordData: JSON.parse(passwordData),
                memoryData: JSON.parse(memoryData),
                passwordCategories: JSON.parse(passwordCategories),
                memoryCategories: JSON.parse(memoryCategories)
            };
            
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `password-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeExportModal();
            showToast('Backup scaricato', 'success');
        }

        // Import data
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importFile').value = '';
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            
            if (!fileInput.files.length) {
                showToast('Seleziona un file', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importObj = JSON.parse(e.target.result);
                    
                    if (!importObj.version || !importObj.salt) {
                        throw new Error('Formato file non valido');
                    }
                    
                    if (!confirm('Questo sostituir√† tutti i dati attuali. Continuare?')) {
                        return;
                    }
                    
                    localStorage.setItem('passwordManager_salt', importObj.salt);
                    
                    // Handle version 2.0 (with memory data)
                    if (importObj.version === '2.0') {
                        localStorage.setItem('passwordManager_data', JSON.stringify(importObj.passwordData || []));
            triggerBackupReminder();
                        localStorage.setItem('passwordManager_memoryData', JSON.stringify(importObj.memoryData || []));
            triggerBackupReminder();
                        localStorage.setItem('passwordManager_categories', JSON.stringify(importObj.passwordCategories || DEFAULT_PASSWORD_CATEGORIES));
                        localStorage.setItem('passwordManager_memoryCategories', JSON.stringify(importObj.memoryCategories || DEFAULT_MEMORY_CATEGORIES));
                    } 
                    // Handle version 1.0 (old format, only passwords)
                    else if (importObj.version === '1.0') {
                        localStorage.setItem('passwordManager_data', JSON.stringify(importObj.data || []));
            triggerBackupReminder();
                        localStorage.setItem('passwordManager_memoryData', JSON.stringify([]));
            triggerBackupReminder();
                        localStorage.setItem('passwordManager_categories', JSON.stringify(DEFAULT_PASSWORD_CATEGORIES));
                        localStorage.setItem('passwordManager_memoryCategories', JSON.stringify(DEFAULT_MEMORY_CATEGORIES));
                    }
                    
                    closeImportModal();
                    logout();
                    showToast('Importazione completata. Effettua nuovamente l\'accesso.', 'success');
                } catch (e) {
                    showToast('Errore durante l\'importazione: ' + e.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Modal functions
        function closeModal() {
            document.getElementById('addEditModal').classList.remove('active');
            clearModalFields();
        }

        function clearModalFields() {
            document.getElementById('entryTitle').value = '';
            const categories = JSON.parse(localStorage.getItem('passwordManager_categories') || JSON.stringify(DEFAULT_PASSWORD_CATEGORIES));
            if (categories.length > 0) {
                document.getElementById('entryCategory').value = categories[0];
            }
            document.getElementById('entryUsername').value = '';
            document.getElementById('entryEmail').value = '';
            document.getElementById('entryPassword').value = '';
            document.getElementById('entryUrl').value = '';
            document.getElementById('entryNotes').value = '';
            document.getElementById('generatedPasswordDisplay').style.display = 'none';
            document.getElementById('strengthBar').className = 'password-strength-bar';
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals on outside click
        document.getElementById('addEditModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target === this) closeExportModal();
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

        document.getElementById('categoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeCategoryModal();
        });

        document.getElementById('addEditMemoryModal').addEventListener('click', function(e) {
            if (e.target === this) closeMemoryModal();
        });

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });

        document.getElementById('instructionsModal').addEventListener('click', function(e) {
            if (e.target === this) closeInstructions();
        });

        // Enter key to login
        document.getElementById('masterPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        // Enter key for setup
        document.getElementById('setupPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('setupPasswordConfirm').focus();
        });

        document.getElementById('setupPasswordConfirm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') completeSetup();
        });

        // Enter key for adding categories
        document.getElementById('newCategoryName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCategory();
        });
    </script>
</body>
</html>